#!/usr/bin/env bash
# ORL Triangulation Beacon - Remote Terminal Client
# More info at https://whereami.bestpoint.institute

# Colors
UNDERLINE="\033[4m"
BOLD="\033[1m"
BOLD_WHITE="\033[1;37m"
GOLD="\033[0;33m"
BOLD_GOLD="\033[1;33m"
RED="\033[0;31m"
BOLD_RED="\033[1;31m"
BLUE="\033[0;34m"
BOLD_BLUE="\033[1;34m"
CYAN="\033[0;36m"
BOLD_CYAN="\033[1;36m"
LIGHT_GREEN="\033[0;32m"
RESET="\033[0m"

# Endpoints
V4_ENDPOINT="https://ipv4.whereami.bestpoint.institute/"
V6_ENDPOINT="https://ipv6.whereami.bestpoint.institute/"

# Get JSON
ipv4_json=$(curl -s "$V4_ENDPOINT")
ipv6_json=$(curl -s "$V6_ENDPOINT")

# Extract IP + rDNS (prefer jq if installed)
if command -v jq >/dev/null 2>&1; then
    ipv4_ip=$(echo "$ipv4_json" | jq -r '.ip')
    ipv4_rdns=$(echo "$ipv4_json" | jq -r '.reverse_dns')
    ipv6_ip=$(echo "$ipv6_json" | jq -r '.ip')
    ipv6_rdns=$(echo "$ipv6_json" | jq -r '.reverse_dns')
else
    ipv4_ip=$(echo "$ipv4_json" | sed -n 's/.*"ip"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p')
    ipv4_rdns=$(echo "$ipv4_json" | sed -n 's/.*"reverse_dns"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p')
    ipv6_ip=$(echo "$ipv6_json" | sed -n 's/.*"ip"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p')
    ipv6_rdns=$(echo "$ipv6_json" | sed -n 's/.*"reverse_dns"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p')
fi

# Mode flag
mode="base"
if [ "$1" = "full" ]; then
    mode="full"
fi

# Function to format output
print_ip() {
    local label=$1
    local ip=$2
    local rdns=$3
    local mode=$4

    if [ -n "$ip" ] && [ "$ip" != "Unavailable" ]; then
        if [ "$mode" = "base" ]; then
            # Base mode: IP + hostname (if valid) in parentheses
            if [ -n "$rdns" ] && [ "$rdns" != "Unavailable" ] && [ "$rdns" != "No PTR record found" ]; then
                echo -e "${BOLD_WHITE}${label}:${RESET} ${GOLD}${ip}${RESET} ${LIGHT_GREEN}(${rdns})${RESET}"
            else
                echo -e "${BOLD_WHITE}${label}:${RESET} ${GOLD}${ip}${RESET}"
            fi
        else
            # Full mode: IP on one row, rDNS on next row (always shown)
            echo -e "${BOLD_CYAN}${UNDERLINE}${label} Connection:${RESET}"
            echo -e " ${BOLD_WHITE}Address:${RESET} ${GOLD}${ip}${RESET}"
            if [ -n "$rdns" ] && [ "$rdns" != "Unavailable" ]; then
                echo -e " ${BOLD_WHITE}Hostname:${RESET} ${LIGHT_GREEN}${rdns}${RESET}"
            else
                echo -e " ${BOLD_WHITE}Hostname:${RESET} ${LIGHT_GREEN}Unavailable${RESET}"
            fi
        fi
    else
        echo -e "${BOLD_WHITE}${label}:${RESET} ${RED}Unavailable${RESET}"
    fi
}

# Output
print_ip "IPv4" "$ipv4_ip" "$ipv4_rdns" "$mode"
print_ip "IPv6" "$ipv6_ip" "$ipv6_rdns" "$mode"
